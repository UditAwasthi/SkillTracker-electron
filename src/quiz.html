<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillTracker | Neural Validation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: #000;
        color: #fff;
        overflow: hidden;
      }
      .option-card {
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.03);
        transition: all 0.25s ease;
      }
      .option-card:hover {
        background: rgba(255, 255, 255, 0.07);
      }
      .option-card.selected {
        border-color: #6366f1;
      }
      .option-card.correct {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.15);
      }
      .option-card.wrong {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.15);
      }
    </style>
  </head>

  <body class="h-screen flex items-center justify-center p-6">
    <main class="w-full max-w-3xl">
      <div class="mb-6 flex justify-between items-center">
        <h2 class="text-3xl font-black italic">Chapter Validation</h2>
        <span id="qCounter" class="text-sm text-white/40"></span>
      </div>

      <div class="border border-white/10 rounded-2xl p-8">
        <div id="quizContainer"></div>
      </div>

      <div class="flex justify-between mt-6">
        <button
          id="abortBtn"
          class="text-white/30 hover:text-red-400 text-xs uppercase"
        >
          Abort
        </button>
        <button
          id="actionBtn"
          class="px-10 py-4 bg-white text-black rounded-full text-xs font-black uppercase tracking-widest"
        >
          Validate â†’
        </button>
      </div>
    </main>

    <script type="module">
      import auth from "./js/auth.js";
      /* ================================
   BOOTSTRAP
================================ */
      const token = localStorage.getItem("accessToken");
      const quizData = JSON.parse(localStorage.getItem("activeQuiz"));
      const returnPath = JSON.parse(localStorage.getItem("quizReturnPath"));
      const course = JSON.parse(localStorage.getItem("courseData"));

      if (!token || !quizData || !returnPath || !course) {
        location.href = "dashboard.html";
      }

      /* ================================
   STATE
================================ */
      let idx = 0;
      let selected = null;
      let revealed = false;
      let correct = 0;

      const questions = quizData.questions;
      const total = questions.length;

      const quizContainer = document.getElementById("quizContainer");
      const actionBtn = document.getElementById("actionBtn");
      const qCounter = document.getElementById("qCounter");

      /* ================================
   LOCAL STORAGE HELPERS
================================ */
      const topicUID = (course.topicName || course.title).replace(/\s+/g, "_");
      const masteryKey = `mastery_${topicUID}`;

      function getLocalMastery() {
        return (
          JSON.parse(localStorage.getItem(masteryKey)) || {
            quizHistory: {},
            totalCorrect: 0,
            totalAttempted: 0,
            completedQuizzes: 0,
          }
        );
      }

      function saveLocalAnswer(isCorrect) {
        const mastery = getLocalMastery();
        mastery.totalAttempted += 1;
        if (isCorrect) mastery.totalCorrect += 1;
        localStorage.setItem(masteryKey, JSON.stringify(mastery));
      }

      /* ================================
   RENDER
================================ */
      function renderQuestion() {
        const q = questions[idx];
        selected = null;
        revealed = false;

        qCounter.textContent = `Question ${idx + 1} / ${total}`;

        quizContainer.innerHTML = `
    <h3 class="text-xl font-bold mb-6">${q.question}</h3>
    <div class="space-y-3">
      ${q.options
        .map(
          (opt, i) => `
        <button class="option-card w-full text-left px-5 py-4 rounded-xl"
          onclick="selectOption(${i})">
          ${String.fromCharCode(65 + i)}. ${opt}
        </button>
      `
        )
        .join("")}
    </div>
    <div id="explanation" class="mt-6 text-sm text-white/40 hidden"></div>
  `;

        actionBtn.textContent = "Validate â†’";
      }

      window.selectOption = (i) => {
        if (revealed) return;
        selected = i;
        document.querySelectorAll(".option-card").forEach((b, idx) => {
          b.classList.toggle("selected", idx === i);
        });
      };

      document.getElementById("abortBtn").onclick = () => {
        if (confirm("Abort validation? Progress lost.")) {
          location.href = "course.html";
        }
      };

      /* ================================
   SAVE ANSWER (BACKEND + LOCAL)
================================ */

      async function saveAnswer({
        courseId,
        chapterIndex,
        topicIndex,
        questionIndex,
        selectedOptionIndex,
        correctOptionIndex,
      }) {
        const res = await auth.authFetch(
          "http://localhost:5500/course/submitAnswer",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              courseId,
              chapterIndex,
              topicIndex,
              questionIndex,
              selectedOptionIndex,
              correctOptionIndex,
            }),
          }
        );

        if (!res.ok) {
          const err = await res.json();
          console.error("Submit answer failed:", err);
          throw new Error("Answer submission failed");
        }

        return res.json();
      }

      /* ================================
   ACTION BUTTON
================================ */
      actionBtn.onclick = async () => {
        if (selected === null) {
          alert("Select an option");
          return;
        }

        const q = questions[idx];
        const correctIdx = Number(q.correctOptionIndex);

        if (!revealed) {
          revealed = true;

          document.querySelectorAll(".option-card").forEach((b, i) => {
            if (i === correctIdx) b.classList.add("correct");
            if (i === selected && i !== correctIdx) b.classList.add("wrong");
          });

          document.getElementById("explanation").textContent =
            q.explanation || "";
          document.getElementById("explanation").classList.remove("hidden");
          console.log({
            courseId: course._id,
            chapterIndex: returnPath.chapterIndex,
            topicIndex: returnPath.topicIndex,
            questionIndex: idx,
            selectedOptionIndex: selected,
            correctOptionIndex: correctIdx,
          });
          // ðŸ”¥ SAVE ANSWER TO BACKEND IMMEDIATELY
          await saveAnswer({
            courseId: course._id,
            chapterIndex: returnPath.chapterIndex,
            topicIndex: returnPath.topicIndex,
            questionIndex: idx,
            selectedOptionIndex: selected,
            correctOptionIndex: correctIdx,
          });

          actionBtn.textContent =
            idx < total - 1 ? "Next â†’" : "Finish Chapter â†’";
          return;
        }

        if (idx < total - 1) {
          idx++;
          renderQuestion();
        } else {
          finalizeChapter();
        }
      };

      /* ================================
   FINALIZE CHAPTER
================================ */
      async function finalizeChapter() {
        const mastery = getLocalMastery();
        mastery.quizHistory[returnPath.chapterTitle] = { passed: true };
        mastery.completedQuizzes += 1;
        localStorage.setItem(masteryKey, JSON.stringify(mastery));

        await fetch("http://localhost:5500/topic-progress/quiz/complete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            courseId: course._id,
            chapterIndex: returnPath.chapterIndex,
            topicIndex: returnPath.topicIndex,
          }),
        });

        localStorage.setItem("lastValidatedChapter", returnPath.chapterTitle);
        localStorage.removeItem("activeQuiz");
        localStorage.removeItem("quizReturnPath");

        location.href = "course.html";
      }

      /* ================================
   EXIT
================================ */
      function abortQuiz() {
        if (confirm("Abort validation? Progress lost.")) {
          location.href = "course.html";
        }
      }

      renderQuestion();
    </script>
  </body>
</html>
