<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillTracker | Mastery Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #050505;
        --accent: #6366f1;
        --glass: rgba(255, 255, 255, 0.02);
        --border: rgba(255, 255, 255, 0.05);
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: var(--bg-dark);
        color: #e2e8f0;
        overflow: hidden;
        letter-spacing: -0.02em;
      }

      .glass-sidebar {
        background: #080808;
        border-right: 1px solid var(--border);
        backdrop-filter: blur(20px);
      }

      .sidebar-item {
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
      }

      .sidebar-item.active {
        background: rgba(99, 102, 241, 0.08);
        color: white;
      }

      .sidebar-item.active::after {
        content: "";
        position: absolute;
        left: 0;
        top: 25%;
        height: 50%;
        width: 3px;
        background: var(--accent);
        box-shadow: 0 0 15px var(--accent);
        border-radius: 0 4px 4px 0;
      }

      .progress-liquid {
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(90deg, #6366f1, #818cf8);
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
      }

      .animate-up {
        animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      pre {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        overflow-x: auto;
      }

      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
    </style>
  </head>

  <body class="h-screen flex">
    <aside class="w-80 glass-sidebar flex flex-col z-20">
      <div class="p-8">
        <div class="flex flex-col gap-6 mb-12">
          <a
            href="dashboard.html"
            class="flex items-center gap-2 text-[10px] font-black text-white/30 uppercase tracking-[0.3em] hover:text-white transition"
          >
            ← Exit to Dashboard
          </a>
          <div class="flex items-center gap-3">
            <div class="w-2 h-8 bg-indigo-600 rounded-full"></div>
            <h1 class="text-xs font-black uppercase tracking-[0.4em]">
              Mastery Mode
            </h1>
          </div>
        </div>

        <nav
          id="chapterList"
          class="space-y-6 overflow-y-auto max-h-[55vh] pr-2"
        ></nav>
      </div>

      <div class="mt-auto p-8 border-t border-white/5 bg-black/20 space-y-6">
        <div>
          <div
            class="flex justify-between text-[9px] mb-3 text-white/20 font-black tracking-widest uppercase"
          >
            <span>Neural Acquisition</span>
            <span id="progressText" class="text-white/60">0%</span>
          </div>
          <div class="h-[2px] w-full bg-white/5 rounded-full overflow-hidden">
            <div
              id="progressBar"
              class="h-full progress-liquid"
              style="width: 0%"
            ></div>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <span
            class="text-[9px] text-white/20 font-black uppercase tracking-widest"
            >Accuracy</span
          >
          <span
            id="accuracyText"
            class="text-sm font-bold italic text-indigo-400"
            >0%</span
          >
        </div>
      </div>
    </aside>

    <main class="flex-1 flex flex-col bg-[#030303]">
      <header
        class="h-20 flex items-center justify-between px-12 border-b border-white/5 bg-black/40 backdrop-blur-md"
      >
        <div
          class="text-[10px] font-bold uppercase tracking-widest text-white/20"
        >
          Vector /
          <span id="currentChapterName" class="text-white/60 italic"
            >Chapter</span
          >
        </div>
      </header>

      <section id="content" class="flex-1 overflow-y-auto px-12 py-16">
        <div class="max-w-3xl mx-auto"></div>
      </section>

      <footer
        class="h-24 px-12 flex items-center justify-between border-t border-white/5 bg-black/60 backdrop-blur-md"
      >
        <button
          id="prevBtn"
          class="text-[10px] font-black uppercase tracking-widest text-white/20 hover:text-white transition"
        >
          ← Previous Segment
        </button>
        <button
          id="nextBtn"
          class="px-10 py-4 bg-white text-black rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-indigo-50 transition"
        >
          Complete & Continue
        </button>
      </footer>
    </main>

    <script type="module">
      import auth from "./js/auth.js";

      /* ================================
   BOOTSTRAP
================================ */
      const course = JSON.parse(localStorage.getItem("courseData"));
      if (!course) location.href = "dashboard.html";

      const courseId = course._id;

      /* ================================
   BACKEND STATE
================================ */
      let progressData = null;
      let currentChapterIdx = 0;
      let currentTopicIdx = 0;

      /* ================================
   FETCH PROGRESS (AUTHORITATIVE)
================================ */
      async function loadProgress() {
        const res = await auth.authFetch(
          `http://localhost:5500/progress/${courseId}`
        );
        if (!res.ok) throw new Error("Failed to load progress");
        progressData = await res.json();
      }

      /* ================================
   HELPERS (BACKEND ONLY)
================================ */
      function isCourseCompleted() {
        return progressData.completed === true;
      }

      function getTopicProgress(cIdx, tIdx) {
        return progressData.topicProgress?.[`${cIdx}:${tIdx}`];
      }

      function isTopicCompleted(cIdx, tIdx) {
        return getTopicProgress(cIdx, tIdx)?.completed === true;
      }

      function buildChapterQuiz(chapter) {
        const questions = [];
        chapter.topics.forEach((t) => {
          if (t.quiz?.questions) questions.push(...t.quiz.questions);
        });
        return questions.length ? { questions } : null;
      }

      /* ================================
   METRICS (PROGRESS + ACCURACY)
================================ */
      function updateMasteryDisplay() {
        const topicProgress = progressData.topicProgress || {};

        const totalTopics = course.chapters.reduce(
          (sum, ch) => sum + ch.topics.length,
          0
        );

        let completedTopics = 0;
        let attempted = 0;
        let correct = 0;

        Object.values(topicProgress).forEach((p) => {
          if (p.completed) completedTopics++;
          attempted += p.attemptedCount || 0;
          correct += p.correctCount || 0;
        });

        const progressPercent = totalTopics
          ? Math.round((completedTopics / totalTopics) * 100)
          : 0;

        const accuracyPercent =
          attempted > 0 ? Math.round((correct / attempted) * 100) : 0;

        document.getElementById(
          "progressBar"
        ).style.width = `${progressPercent}%`;
        document.getElementById(
          "progressText"
        ).textContent = `${progressPercent}%`;
        document.getElementById(
          "accuracyText"
        ).textContent = `${accuracyPercent}%`;
      }

      /* ================================
   SIDEBAR
================================ */
      function renderSidebar() {
        document.getElementById("chapterList").innerHTML = course.chapters
          .map(
            (ch, cIdx) => `
      <div class="mb-6">
        <div class="flex justify-between px-4 mb-2">
          <span class="text-[8px] uppercase text-white/30">
            ${ch.chapterTitle}
          </span>
        </div>
        ${ch.topics
          .map(
            (t, tIdx) => `
          <button onclick="goToTopic(${cIdx},${tIdx})"
            class="w-full px-4 py-3 text-left text-[11px]
            ${
              isTopicCompleted(cIdx, tIdx)
                ? "text-emerald-400"
                : "text-white/30"
            }
            ${
              cIdx === currentChapterIdx && tIdx === currentTopicIdx
                ? "font-bold text-white"
                : "hover:text-white/60"
            }">
            ${t.title}
          </button>
        `
          )
          .join("")}
      </div>
    `
          )
          .join("");
      }

      /* ================================
   CONTENT
================================ */
      function renderContent() {
        const chapter = course.chapters[currentChapterIdx];
        const topic = chapter.topics[currentTopicIdx];

        document.getElementById("currentChapterName").textContent =
          chapter.chapterTitle;

        document.querySelector("#content .max-w-3xl").innerHTML = `
    <h1 class="text-5xl font-black italic uppercase mb-6">${topic.title}</h1>
    <p class="text-white/40 mb-10">${topic.content.description}</p>
    ${topic.content.sections
      .map((sec) =>
        sec.type === "text"
          ? `<p class="text-white/70 mb-4">${sec.value}</p>`
          : `<pre><code>${sec.code}</code></pre>`
      )
      .join("")}
  `;

        const nextBtn = document.getElementById("nextBtn");

        const isLastChapter = currentChapterIdx === course.chapters.length - 1;
        const isLastTopic = currentTopicIdx === chapter.topics.length - 1;
        const topicDone = isTopicCompleted(currentChapterIdx, currentTopicIdx);
        const chapterQuiz = buildChapterQuiz(chapter);

        if (isCourseCompleted()) {
          nextBtn.textContent = "Achieve Mastery →";
          nextBtn.className =
            "px-10 py-4 bg-emerald-500 text-black rounded-full font-black uppercase";
        } else if (isLastTopic && chapterQuiz && !topicDone) {
          nextBtn.textContent = "Begin Chapter Validation →";
        } else {
          nextBtn.textContent = "Complete & Continue →";
        }

        renderSidebar();
        updateMasteryDisplay();
        document.getElementById("content").scrollTop = 0;
      }

      /* ================================
   NAVIGATION
================================ */
      window.goToTopic = (c, t) => {
        currentChapterIdx = c;
        currentTopicIdx = t;
        renderContent();
      };

      document.getElementById("nextBtn").onclick = async () => {
        const chapter = course.chapters[currentChapterIdx];
        const isLastChapter = currentChapterIdx === course.chapters.length - 1;
        const isLastTopic = currentTopicIdx === chapter.topics.length - 1;

        if (isCourseCompleted()) {
          location.href = "success.html";
          return;
        }

        if (
          isLastTopic &&
          !isTopicCompleted(currentChapterIdx, currentTopicIdx)
        ) {
          const quiz = buildChapterQuiz(chapter);
          if (quiz) {
            localStorage.setItem("activeQuiz", JSON.stringify(quiz));
            localStorage.setItem(
              "quizReturnPath",
              JSON.stringify({
                chapterIndex: currentChapterIdx,
                topicIndex: currentTopicIdx,
                chapterTitle: chapter.chapterTitle,
              })
            );
            location.href = "quiz.html";
            return;
          }
        }

        await auth.authFetch("http://localhost:5500/progress/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            courseId,
            chapterIndex: currentChapterIdx,
            topicIndex: currentTopicIdx,
          }),
        });

        if (currentTopicIdx < chapter.topics.length - 1) {
          currentTopicIdx++;
        } else if (!isLastChapter) {
          currentChapterIdx++;
          currentTopicIdx = 0;
        }

        renderContent();
      };

      document.getElementById("prevBtn").onclick = () => {
        if (currentTopicIdx > 0) {
          currentTopicIdx--;
        } else if (currentChapterIdx > 0) {
          currentChapterIdx--;
          currentTopicIdx =
            course.chapters[currentChapterIdx].topics.length - 1;
        }
        renderContent();
      };

      /* ================================
   INIT
================================ */
      await loadProgress();

      // Resume from backend progress
      if (progressData.progress) {
        currentChapterIdx = progressData.progress.chapterIndex ?? 0;
        currentTopicIdx = progressData.progress.topicIndex ?? 0;
      }

      renderContent();
    </script>
  </body>
</html>
