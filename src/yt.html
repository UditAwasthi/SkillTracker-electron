<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temporal Engine | Linear Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap");

        body {
            font-family: "Plus Jakarta Sans", sans-serif;
            background-color: #050505;
            color: #ffffff;
            margin: 0;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar for the timeline */
        .timeline-container::-webkit-scrollbar {
            height: 6px;
        }
        .timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .timeline-container::-webkit-scrollbar-thumb {
            background: #ff5733;
            border-radius: 10px;
        }

        .video-card {
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .video-card:hover {
            transform: translateY(-10px);
            border-color: rgba(255, 87, 51, 0.4);
            background: rgba(255, 255, 255, 0.06);
        }

        .day-divider {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-8 flex flex-col md:flex-row justify-between items-start gap-6 z-20">
        <div>
            <p class="text-[10px] font-black uppercase tracking-[0.3em] text-orange-500 mb-1">Architecture v3.0</p>
            <h1 class="text-4xl font-black tracking-tighter italic">TEMPORAL ENGINE</h1>
        </div>

        <form id="form" class="glass p-2 rounded-3xl flex gap-2 w-full md:w-auto">
            <input id="input-url" placeholder="Playlist URL" class="bg-transparent px-6 py-3 rounded-2xl outline-none text-sm font-semibold flex-grow md:min-w-[350px] text-white" required />
            <input id="input-minutes" type="number" placeholder="Min/Day" class="bg-white/5 px-4 py-3 rounded-2xl outline-none text-sm font-bold w-24 text-white" required />
            <button class="bg-white text-black px-8 py-3 rounded-2xl text-xs font-black uppercase hover:bg-orange-500 hover:text-white transition-all active:scale-95">Generate</button>
        </form>
    </header>

    <main id="timeline" class="timeline-container flex flex-nowrap items-center gap-8 overflow-x-auto px-10 pb-20 pt-10 flex-grow">
        <div id="empty-state" class="w-full text-center opacity-20 py-20">
            <p class="text-2xl font-light">Paste a playlist to initialize the stream...</p>
        </div>
    </main>

    <script type="module">
        import auth from "./js/auth.js";

        const API = "http://localhost:5500/youtube/playlist";
        const timeline = document.getElementById('timeline');

        function parseDuration(iso) {
            const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            const h = match[1] ? match[1].padStart(2, '0') + ':' : '';
            const m = (match[2] || '0').padStart(2, '0');
            const s = (match[3] || '0').padStart(2, '0');
            return `${h}${m}:${s}`;
        }

        function createVideoWidget(video, dayIndex) {
            const duration = parseDuration(video.duration);
            
            return `
                <div class="video-card glass p-5 rounded-[32px] w-[380px] shrink-0 border border-white/10 group">
                    <div class="w-full aspect-video rounded-2xl bg-cover bg-center mb-4 ring-1 ring-white/10 shadow-inner overflow-hidden relative">
                        <img src="${video.thumbnails}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
                    </div>
                    
                    <div class="space-y-3 px-1">
                        <div class="flex justify-between items-center">
                            <span class="bg-orange-500/20 text-orange-500 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">Day ${dayIndex}</span>
                            <span class="text-white/40 text-[10px] font-bold font-mono">${duration}</span>
                        </div>

                        <div>
                            <h2 class="text-lg font-bold text-white leading-tight line-clamp-2 min-h-[3.5rem]">${video.title}</h2>
                            <p class="text-white/40 text-[11px] font-medium mt-1 uppercase tracking-widest">${video.channel}</p>
                        </div>

                        <div class="pt-2">
                            <button onclick="window.open('https://youtube.com/watch?v=${video.videoId}')" class="w-full bg-white text-black py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-orange-500 hover:text-white transition-colors duration-300 active:scale-95">
                                Start Sequence
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById("form").onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById("input-url").value.trim();
            const limit = Number(document.getElementById("input-minutes").value);

            try {
                const res = await auth.authFetch(API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url }),
                });
                const data = await res.json();
                
                if (data.videos) {
                    timeline.innerHTML = ''; // Clear empty state
                    let currentDay = 1;
                    let dailyTotal = 0;

                    data.videos.forEach((video) => {
                        const match = video.duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
                        const mins = (Number(match?.[1]||0)*60 + Number(match?.[2]||0));

                        if (dailyTotal + mins > limit && dailyTotal > 0) {
                            currentDay++;
                            dailyTotal = 0;
                            
                            // Add a subtle Day Divider
                            const divider = document.createElement('div');
                            divider.className = 'day-divider h-64 flex items-center justify-center border-l border-white/5 mx-4';
                            divider.innerHTML = `<span class="text-white/10 text-[10px] font-black uppercase tracking-[1em]">Phase ${currentDay}</span>`;
                            timeline.appendChild(divider);
                        }

                        const widgetWrap = document.createElement('div');
                        widgetWrap.innerHTML = createVideoWidget(video, currentDay);
                        timeline.appendChild(widgetWrap.firstElementChild);
                        
                        dailyTotal += mins;
                    });
                }
            } catch (err) {
                console.error("System sync failed:", err);
            }
        };
    </script>
</body>
</html>