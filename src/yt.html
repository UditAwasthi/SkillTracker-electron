<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillTracker | Chromatic Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=JetBrains+Mono:wght@500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            letter-spacing: -0.03em;
            margin: 0;
            overflow: hidden;
        }

        .squircle { border-radius: 38px; }
        
        .glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        #scroll-wrapper {
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            z-index: 10;
            will-change: transform;
        }

        /* Chromatic Card Styling */
        .video-card {
            transition: all 0.7s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        
        .video-card:hover {
            transform: translateY(-25px) scale(1.02);
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--phase-color);
            box-shadow: 0 20px 80px -20px var(--phase-glow);
        }

        .video-card img {
            transition: transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .video-card:hover img {
            transform: scale(1.1);
        }

        /* Day Label Accents */
        .day-badge {
            font-family: 'JetBrains Mono', monospace;
            background: var(--phase-glow);
            color: var(--phase-color);
            border: 1px solid var(--phase-color);
        }

        /* Progress Line */
        #progress-rail {
            position: fixed;
            bottom: 40px;
            left: 10%;
            width: 80%;
            height: 2px;
            background: rgba(255, 255, 255, 0.05);
            z-index: 100;
        }
        #progress-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #fff, var(--current-color, #fff));
            box-shadow: 0 0 20px var(--current-color, transparent);
            transition: background 0.5s ease;
        }

        .phase-divider {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            color: var(--phase-color);
            opacity: 0.3;
        }

        .key-hint {
            transition: all 0.2s ease;
        }
        .key-active {
            color: var(--current-color, #fff) !important;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed top-0 left-0 w-full flex justify-between items-center px-10 py-10 z-50 pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="w-5 h-5 bg-white rounded-[6px]"></div>
            <span class="font-bold text-base tracking-tighter">SkillTracker</span>
        </div>
        
        <form id="form" class="glass px-2 py-2 squircle flex gap-2 pointer-events-auto shadow-2xl">
            <input id="input-url" placeholder="Paste YouTube Playlist" class="bg-transparent px-6 py-2 outline-none text-xs font-medium w-72 text-white/40 focus:text-white" required />
            <input id="input-minutes" type="number" placeholder="Mins" class="bg-white/5 px-3 py-2 rounded-2xl outline-none text-[10px] font-bold w-20 text-center" required />
            <button class="bg-white text-black px-8 py-2 squircle text-[10px] font-black uppercase tracking-widest hover:bg-transparent hover:text-white border border-transparent hover:border-white transition-all">Sync</button>
        </form>
    </nav>

    <div id="scroll-wrapper" class="px-24 gap-20">
        <div id="empty-state" class="w-screen flex flex-col justify-center">
            <h1 class="text-[12vw] font-black tracking-tighter leading-none opacity-[0.03] select-none">CHROMATIC<br>ENGINE.</h1>
        </div>
    </div>

    <div id="progress-rail"><div id="progress-fill"></div></div>
    
    <footer class="fixed bottom-0 left-0 w-full px-10 py-12 flex justify-between items-end z-50 pointer-events-none">
        <div class="flex gap-8">
            <div class="space-y-1">
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-[0.4em]">Current Phase</p>
                <p id="active-phase" class="text-sm font-bold transition-colors duration-500">Node 01</p>
            </div>
        </div>
        
        <div class="flex items-center gap-6 opacity-30 pointer-events-auto">
            <div id="key-left" class="key-hint text-[10px] font-bold border border-white/20 px-2 py-1 rounded-md">←</div>
            <span class="text-[9px] font-bold uppercase tracking-widest">Navigate</span>
            <div id="key-right" class="key-hint text-[10px] font-bold border border-white/20 px-2 py-1 rounded-md">→</div>
        </div>

        <div class="flex items-center gap-4 opacity-30">
            <span class="text-[9px] font-bold uppercase tracking-widest">Obsidian Chromatic v2.2</span>
        </div>
    </footer>

    <script type="module">
        import auth from "./js/auth.js";

        const wrapper = document.getElementById('scroll-wrapper');
        const progressFill = document.getElementById('progress-fill');
        const phaseIndicator = document.getElementById('active-phase');
        const keyL = document.getElementById('key-left');
        const keyR = document.getElementById('key-right');
        
        let targetX = 0, currentX = 0, maxScroll = 0;
        const ease = 0.08;
        const scrollStep = 500; // Pixels per arrow click

        const colors = ['#FF5F6D', '#FFC371', '#00F2FF', '#70FF00', '#BF5AF2', '#FF375F'];

        // 1. Mouse Wheel Scroll
        window.addEventListener('wheel', (e) => {
            targetX -= (e.deltaY + e.deltaX) * 0.9;
            clampScroll();
        });

        // 2. Keyboard Arrow Scroll
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                targetX -= scrollStep;
                keyR.classList.add('key-active');
                setTimeout(() => keyR.classList.remove('key-active'), 150);
            }
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                targetX += scrollStep;
                keyL.classList.add('key-active');
                setTimeout(() => keyL.classList.remove('key-active'), 150);
            }
            clampScroll();
        });

        function clampScroll() {
            maxScroll = -(wrapper.offsetWidth - window.innerWidth + 300);
            targetX = Math.min(0, Math.max(targetX, maxScroll || 0));
        }

        function animate() {
            currentX += (targetX - currentX) * ease;
            wrapper.style.transform = `translate3d(${currentX}px, 0, 0)`;

            if (maxScroll !== 0) {
                const progress = (currentX / maxScroll) * 100;
                progressFill.style.width = `${progress}%`;
                
                const cards = document.querySelectorAll('.video-card');
                const idx = Math.min(cards.length - 1, Math.max(0, Math.floor(Math.abs(currentX) / 550)));
                if(cards[idx]) {
                    const c = cards[idx].style.getPropertyValue('--phase-color');
                    phaseIndicator.style.color = c;
                    phaseIndicator.innerText = `Node 0${cards[idx].dataset.day}`;
                    document.documentElement.style.setProperty('--current-color', c);
                }
            }
            requestAnimationFrame(animate);
        }
        animate();

        function createCard(video, day) {
            const color = colors[(day - 1) % colors.length];
            return `
                <div class="video-card glass p-8 squircle w-[480px] shrink-0" 
                     data-day="${day}" 
                     style="--phase-color: ${color}; --phase-glow: ${color}22">
                    
                    <div class="flex justify-between items-center mb-8">
                        <span class="day-badge px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider">Day ${day}</span>
                        <span class="text-[9px] font-mono text-white/20">SEQ_${video.videoId.slice(0,5)}</span>
                    </div>
                    
                    <div class="w-full aspect-video squircle overflow-hidden mb-8 ring-1 ring-white/10 shadow-2xl">
                        <img src="${video.thumbnails}" class="w-full h-full object-cover">
                    </div>

                    <h2 class="text-2xl font-bold leading-tight tracking-tighter mb-10 h-16 line-clamp-2">${video.title}</h2>
                    
                    <button onclick="window.open('https://youtube.com/watch?v=${video.videoId}')" 
                            class="w-full py-4 squircle text-[10px] font-black uppercase tracking-[0.2em] border border-white/10 hover:bg-white hover:text-black transition-all">
                        Initialize Session
                    </button>
                </div>
            `;
        }

        document.getElementById("form").onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById("input-url").value.trim();
            const limit = Number(document.getElementById("input-minutes").value);

            try {
                const res = await auth.authFetch("https://st-v01.onrender.com/youtube/playlist", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url }),
                });
                const data = await res.json();
                
                if (data.videos) {
                    wrapper.innerHTML = '';
                    let currentDay = 1, dailyTotal = 0;

                    data.videos.forEach((video) => {
                        const match = video.duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
                        const mins = (Number(match?.[1]||0)*60 + Number(match?.[2]||0));

                        if (dailyTotal + mins > limit && dailyTotal > 0) {
                            currentDay++; dailyTotal = 0;
                            const div = document.createElement('div');
                            div.className = 'phase-divider shrink-0 mx-10 text-[10px] font-black uppercase tracking-[1em]';
                            div.style.setProperty('--phase-color', colors[(currentDay-1)%colors.length]);
                            div.innerHTML = `PHASE 0${currentDay}`;
                            wrapper.appendChild(div);
                        }

                        const cardWrap = document.createElement('div');
                        cardWrap.innerHTML = createCard(video, currentDay);
                        wrapper.appendChild(cardWrap.firstElementChild);
                        dailyTotal += mins;
                    });
                    
                    setTimeout(() => { clampScroll(); targetX = 0; }, 200);
                }
            } catch (err) { console.error(err); }
        };
    </script>
</body>
</html>