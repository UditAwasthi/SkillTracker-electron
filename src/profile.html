<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Executive Dashboard | SkillTracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap");

      :root {
        --bg: #ffffff;
        --card: #f9f9f9;
        --border: #f1f1f1;
        --streak: #ff5733;
        --mastery: #000000;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: var(--bg);
        color: #1a1a1a;
        padding: 40px 20px;
      }

      .bento-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .widget {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 32px;
        padding: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .widget:hover {
        background: #fff;
        border-color: #000;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px);
      }

      .label-caps {
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #a1a1aa;
        margin-bottom: 12px;
        display: block;
      }

      /* Circular Progress Logic */
      .ring-container {
        position: relative;
        width: 100px;
        height: 100px;
      }

      .progress-ring-circle {
        transition: stroke-dashoffset 1s ease-in-out;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      /* Heatmap Grid */
      .heatmap {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .heat-cell {
        aspect-ratio: 1;
        background: #eee;
        border-radius: 4px;
      }

      #courseList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      /* Responsive */
      @media (max-width: 1100px) {
        .span-desktop-6 {
          grid-column: span 12 !important;
        }
        .span-desktop-3 {
          grid-column: span 6 !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="bento-grid">
      <div class="widget col-span-12 lg:col-span-6 flex items-center gap-8">
        <div class="relative">
          <div
            class="w-24 h-24 rounded-[32px] overflow-hidden border-4 border-white shadow-xl"
          >
            <img
              id="navAvatar"
              src=""
              alt="User"
              class="w-full h-full object-cover"
            />
          </div>
          <div
            class="absolute -bottom-2 -right-2 bg-green-500 w-6 h-6 rounded-full border-4 border-white"
          ></div>
        </div>
        <div class="flex-1 min-w-0">
          <p class="label-caps">Active Session</p>
          <h1
            id="profileName"
            class="text-4xl font-black tracking-tighter truncate"
          >
            --
          </h1>
          <p id="profileEmail" class="text-gray-400 font-medium truncate">--</p>
        </div>
      </div>

      <div
        class="widget col-span-6 lg:col-span-3 flex flex-col items-center justify-center"
      >
        <span class="label-caps">Consistency</span>
        <div class="ring-container">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle
              cx="50"
              cy="50"
              r="45"
              stroke="#eee"
              stroke-width="8"
              fill="none"
            />
            <circle
              id="streakRing"
              cx="50"
              cy="50"
              r="45"
              stroke="var(--streak)"
              stroke-width="8"
              fill="none"
              stroke-dasharray="282.7"
              stroke-dashoffset="282.7"
              stroke-linecap="round"
              class="progress-ring-circle"
            />
          </svg>
          <div
            class="absolute inset-0 flex flex-col items-center justify-center"
          >
            <span id="streakVal" class="text-2xl font-black">0</span>
            <span class="text-[8px] font-bold text-gray-400">STREAK</span>
          </div>
        </div>
      </div>

      <div
        class="widget col-span-6 lg:col-span-3 flex flex-col items-center justify-center"
      >
        <span class="label-caps">Avg. Mastery</span>
        <div class="ring-container">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle
              cx="50"
              cy="50"
              r="45"
              stroke="#eee"
              stroke-width="8"
              fill="none"
            />
            <circle
              id="masteryRing"
              cx="50"
              cy="50"
              r="45"
              stroke="var(--mastery)"
              stroke-width="8"
              fill="none"
              stroke-dasharray="282.7"
              stroke-dashoffset="282.7"
              stroke-linecap="round"
              class="progress-ring-circle"
            />
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <span id="masteryPercent" class="text-2xl font-black">0%</span>
          </div>
        </div>
      </div>

      <div class="widget col-span-12 flex flex-col justify-center py-10">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 px-4">
          <div>
            <p class="label-caps">Total Time</p>
            <p id="totalTimeLarge" class="text-4xl font-black tracking-tighter">
              0h 0m
            </p>
            <p id="totalTime" class="hidden">0h 0m</p>
          </div>
          <div>
            <p class="label-caps">Curriculums</p>
            <p
              id="courseCountLarge"
              class="text-4xl font-black tracking-tighter"
            >
              00
            </p>
            <p id="courseCount" class="hidden">00</p>
          </div>
          <div>
            <p class="label-caps">Avg. Accuracy</p>
            <p
              id="avgAccuracyLarge"
              class="text-4xl font-black tracking-tighter"
            >
              0%
            </p>
          </div>
          <div>
            <p class="label-caps">DB Status</p>
            <div class="flex items-baseline gap-2">
              <p class="text-4xl font-black tracking-tighter text-green-500">
                LIVE
              </p>
              <span class="text-[10px] font-bold text-gray-400">V.22</span>
            </div>
          </div>
        </div>
      </div>

      <div class="widget col-span-12 lg:col-span-8">
        <span class="label-caps">Learning Velocity (7-Day Trend)</span>
        <div class="h-64 mt-4">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <div class="widget col-span-12 lg:col-span-4">
        <span class="label-caps">Skill Balance (Radar)</span>
        <div class="h-64 mt-4">
          <canvas id="skillRadar"></canvas>
        </div>
      </div>

      <div class="widget col-span-12">
        <div class="flex justify-between items-center mb-6">
          <div>
            <span class="label-caps">Activity Architecture</span>
            <h3 class="text-xl font-black tracking-tight">
              Consistency Heatmap
            </h3>
          </div>
          <div
            class="flex gap-2 items-center text-[10px] font-bold text-gray-400"
          >
            <span>LESS</span>
            <div class="w-3 h-3 bg-gray-100 rounded-sm"></div>
            <div class="w-3 h-3 bg-gray-300 rounded-sm"></div>
            <div class="w-3 h-3 bg-gray-600 rounded-sm"></div>
            <div class="w-3 h-3 bg-black rounded-sm"></div>
            <span>MORE</span>
          </div>
        </div>
        <div
          id="fullHeatmap"
          class="grid grid-flow-col grid-rows-7 gap-1.5 overflow-x-auto pb-4 custom-scrollbar"
        ></div>
      </div>

      <div class="widget col-span-12 lg:col-span-4">
        <span class="label-caps">Knowledge Spheres</span>
        <div
          id="topicCloud"
          class="flex flex-wrap gap-2 mt-4 content-start"
        ></div>
      </div>

      <div class="col-span-12 lg:col-span-8">
        <div class="flex justify-between items-center mb-6 px-4">
          <h2 class="text-xl font-black uppercase tracking-tight">
            Active Dossier
          </h2>
          <span class="text-[10px] font-bold text-gray-400"
            >SORTED BY RECENT</span
          >
        </div>
        <div
          id="courseList"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
        ></div>
      </div>
    </div>
    <footer
      class="max-w-[1400px] mx-auto mt-12 px-4 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest"
    >
      <div class="flex items-center gap-6">
        <span class="flex items-center gap-2"
          ><span class="w-2 h-2 rounded-full bg-green-500"></span> DB:
          MongoDB_Atlas</span
        >
        <span>Env: Production_V22</span>
      </div>
      <div class="flex items-center gap-6">
        <span
          >Last Sync:
          <span id="syncTime" class="text-black">--:--:--</span></span
        >
        <button
          onclick="logout()"
          class="text-red-500 hover:scale-110 transition-transform"
        >
          Terminate Session
        </button>
      </div>
    </footer>

    <script type="module">
      import auth from "./js/auth.js";

      const STATE = { profile: null };

      document.addEventListener("DOMContentLoaded", init);

      async function init() {
        loadFromCache();
        render();
        try {
          const snapshot = await fetchProfile();
          STATE.profile = snapshot;
          localStorage.setItem("user_profile", JSON.stringify(snapshot));
          render();
        } catch (err) {
          console.error("Data Sync Failure", err);
        }
      }

      async function fetchProfile() {
        const res = await auth.authFetch(
          "http://localhost:5500/profile/profile",
          { method: "GET" }
        );
        if (!res.ok) throw new Error("API Connection Failed");
        return res.json();
      }

      function loadFromCache() {
        const cached = localStorage.getItem("user_profile");
        if (cached) STATE.profile = JSON.parse(cached);
      }

      function render() {
        if (!STATE.profile) return;
        const { user, stats, courses } = STATE.profile;

        // 1. IDENTITY & METADATA
        document.getElementById("profileName").innerText =
          user.name || "Accessing...";
        document.getElementById("profileEmail").innerText = user.email || "";
        document.getElementById("navAvatar").src =
          user.avatar || "https://loremfaces.net/128/id/1.jpg";
        document.getElementById("syncTime").innerText =
          new Date().toLocaleTimeString();

        // 2. STATS CALCULATIONS (Calculate once, use everywhere)
        const sec = stats.totalLearningTime || 0;
        const timeStr = `${Math.floor(sec / 3600)}h ${Math.floor(
          (sec % 3600) / 60
        )}m`;
        const courseCountStr = String(courses.length).padStart(2, "0");

        const totalAcc = courses.reduce(
          (a, c) => a + calculateAccuracy(c.topicProgress),
          0
        );
        const avgAcc = courses.length
          ? Math.round(totalAcc / courses.length)
          : 0;

        // 3. UI UPDATES (Small & Large Widgets)
        document.getElementById("totalTime").innerText = timeStr;
        document.getElementById("totalTimeLarge").innerText = timeStr;

        document.getElementById("courseCount").innerText = courseCountStr;
        document.getElementById("courseCountLarge").innerText = courseCountStr;

        document.getElementById("avgAccuracyLarge").innerText = `${avgAcc}%`;

        // 4. GAUGES
        updateGauge("streakRing", "streakVal", stats.streak || 0, 30, false);
        updateGauge("masteryRing", "masteryPercent", avgAcc, 100, true);

        // 5. VISUALIZATIONS
        renderFullHeatmap();
        renderTopicCloud(courses);
        renderVelocityChart();
        renderRadarChart(courses);
        renderCourses(courses);
      }

      function updateGauge(ringId, textId, val, max, isPct) {
        const ring = document.getElementById(ringId);
        const txt = document.getElementById(textId);
        if (!ring || !txt) return;
        const circ = 2 * Math.PI * 45;
        const pct = Math.min((val / (max || 1)) * 100, 100);
        ring.style.strokeDashoffset = circ - (pct / 100) * circ;
        txt.innerText = isPct ? `${val}%` : val;
      }

      function renderVelocityChart() {
        const ctx = document.getElementById("weeklyChart");
        if (!ctx) return;
        if (window.vChart) window.vChart.destroy();
        window.vChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                label: "Study Time",
                data: [30, 45, 12, 80, 50, 20, 40],
                borderColor: "#000",
                backgroundColor: "rgba(0,0,0,0.05)",
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { display: false }, x: { grid: { display: false } } },
            maintainAspectRatio: false,
          },
        });
      }

      function renderRadarChart(courses) {
        const ctx = document.getElementById("skillRadar");
        if (!ctx) return;
        if (window.rChart) window.rChart.destroy();
        window.rChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["Speed", "Accuracy", "Logic", "Recall", "Volume"],
            datasets: [
              {
                data: [80, 90, 70, 60, 85],
                backgroundColor: "rgba(0,0,0,0.1)",
                borderColor: "#000",
                borderWidth: 2,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              r: { ticks: { display: false }, grid: { color: "#eee" } },
            },
            maintainAspectRatio: false,
          },
        });
      }

      function renderCourses(courses) {
        const container = document.getElementById("courseList");
        if (!container) return;
        container.innerHTML = courses
          .map((c) => {
            const acc = calculateAccuracy(c.topicProgress);
            return `
        <div class="widget p-6 mb-4">
          <div class="flex justify-between items-center mb-4">
            <span class="text-[9px] font-black bg-black text-white px-2 py-1 rounded uppercase tracking-widest">
              ${
                c.completed
                  ? "Certified"
                  : "Ch. " + (c.progress.chapterIndex + 1)
              }
            </span>
            <span class="text-[10px] font-bold text-gray-400 uppercase">
              ${new Date(c.lastAccessedAt).toLocaleDateString()}
            </span>
          </div>
          <h3 class="text-lg font-bold mb-6">${c.title}</h3>
          <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden mb-2">
            <div class="h-full bg-black transition-all duration-1000" style="width: ${acc}%"></div>
          </div>
          <div class="flex justify-between text-[10px] font-black uppercase">
            <span>Mastery Level</span>
            <span>${acc}%</span>
          </div>
        </div>`;
          })
          .join("");
      }

      function calculateAccuracy(tp = {}) {
        let c = 0,
          a = 0;
        Object.values(tp).forEach((x) => {
          c += x.correctCount || 0;
          a += x.attemptedCount || 0;
        });
        return a ? Math.round((c / a) * 100) : 0;
      }

      function renderFullHeatmap() {
        const container = document.getElementById("fullHeatmap");
        if (!container) return;
        container.innerHTML = "";
        // 364 cells for a full year view
        for (let i = 0; i < 364; i++) {
          const cell = document.createElement("div");
          cell.className = "w-3 h-3 rounded-sm";
          const intensities = ["#f3f4f6", "#d1d5db", "#4b5563", "#000000"];
          cell.style.backgroundColor =
            intensities[Math.floor(Math.random() * intensities.length)];
          container.appendChild(cell);
        }
      }

      function renderTopicCloud(courses) {
        const container = document.getElementById("topicCloud");
        if (!container) return;
        container.innerHTML = "";
        courses.forEach((c, i) => {
          const tag = document.createElement("span");
          const sizes = ["text-xs", "text-sm", "text-base"];
          tag.className = `${
            sizes[i % 3]
          } font-bold px-3 py-1 bg-white border border-gray-100 rounded-full shadow-sm uppercase tracking-tight transition-transform hover:scale-110 cursor-default`;
          tag.innerText = c.title;
          container.appendChild(tag);
        });
      }

      window.logout = () => auth.logout();
    </script>
  </body>
</html>
