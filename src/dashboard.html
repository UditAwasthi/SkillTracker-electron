<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillTracker â€“ Neural Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap");

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: #000;
        color: #fff;
        letter-spacing: -0.03em;
        overflow-x: hidden;
      }

      .squircle {
        border-radius: 24px;
      }
      .squircle-lg {
        border-radius: 32px;
      }

      .glass {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .text-display {
        font-size: clamp(2.5rem, 6vw, 5rem);
        line-height: 0.9;
        font-weight: 800;
        letter-spacing: -0.05em;
        text-transform: uppercase;
      }

      .vector-card {
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .vector-card::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: var(--progress, 0%);
        background: linear-gradient(
          180deg,
          rgba(99, 102, 241, 0.15) 0%,
          rgba(99, 102, 241, 0.05) 100%
        );
        transition: height 1.5s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: -1;
        border-top: 1px solid rgba(99, 102, 241, 0.3);
      }

      .vector-card:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-4px);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-up {
        animation: slideUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body class="antialiased min-h-screen flex flex-col">
    <div
      id="loaderOverlay"
      class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden flex-col items-center justify-center text-center p-6"
    >
      <div class="spinner mb-8"></div>
      <h2
        id="loaderStatus"
        class="text-3xl font-extrabold tracking-tighter mb-2 italic uppercase"
      >
        Synthesizing
      </h2>
      <p
        class="text-white/40 text-[10px] font-bold tracking-[0.3em] uppercase max-w-xs leading-relaxed"
      >
        Neural architecture mapping in progress...
      </p>
    </div>

    <div
      class="w-full border-b border-white/5 bg-black/50 backdrop-blur-md px-10 py-4 flex justify-between items-center sticky top-0 z-[60]"
    >
      <div class="flex gap-8 items-center">
        <div class="flex flex-col">
          <span
            class="text-[8px] text-white/20 uppercase font-black tracking-widest"
            >Neural Streak</span
          >
          <span id="streakVal" class="text-xs font-bold text-indigo-400"
            >-- DAYS</span
          >
        </div>
        <div class="h-6 w-[1px] bg-white/5"></div>
        <div class="flex flex-col">
          <span
            class="text-[8px] text-white/20 uppercase font-black tracking-widest"
            >Total Acquisition Time</span
          >
          <span id="timeVal" class="text-xs font-bold text-white"
            >00:00:00</span
          >
        </div>
      </div>
      <div class="hidden md:flex items-center gap-3">
        <span
          id="welcomeMsg"
          class="text-[10px] font-bold text-white/40 uppercase tracking-widest"
          >Operator Active</span
        >
        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
      </div>
    </div>

    <nav class="flex justify-between items-center px-10 py-10 relative z-50">
      <div
        class="flex items-center gap-4 group cursor-pointer"
        onclick="window.location.reload()"
      >
        <div
          class="w-6 h-6 bg-white rounded-[6px] transition-transform duration-500 group-hover:rotate-90"
        ></div>
        <span class="font-black text-lg tracking-tighter uppercase italic"
          >SkillTracker</span
        >
      </div>

      <div class="flex items-center gap-10">
        <div
          class="flex gap-10 text-[10px] font-black uppercase tracking-[0.2em]"
        >
          <a
            href="dashboard.html"
            class="text-white border-b border-white/40 pb-1"
            >Vectors</a
          >
          <a
            href="yt.html"
            class="text-white/30 hover:text-white transition-all"
            >youtube</a
          >
          <a
            href="roadmap.html"
            class="text-white/30 hover:text-white transition-all"
            >Roadmap</a
          >
        </div>
        <button
          id="logoutBtn"
          class="px-6 py-2 border border-red-500/20 text-red-500/50 hover:bg-red-500 hover:text-white transition-all text-[9px] font-black uppercase tracking-widest squircle"
        >
          Terminate
        </button>
      </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto w-full px-10 py-12">
      <section class="mb-24">
        <div class="animate-up">
          <h1 class="text-display">
            COMMAND <br /><span class="text-white/20 italic font-light"
              >CENTER.</span
            >
          </h1>
        </div>

        <div class="animate-up mt-12" style="animation-delay: 0.1s">
          <div
            class="glass squircle-lg p-2 flex flex-col md:flex-row gap-2 border border-white/10 focus-within:ring-4 ring-indigo-500/10 transition-all"
          >
            <input
              id="topicInput"
              type="text"
              autocomplete="off"
              placeholder="What domain are we acquiring today?"
              class="flex-1 bg-transparent px-8 py-5 text-xl outline-none placeholder:text-white/5 font-medium"
            />
            <button
              id="startBtn"
              class="bg-white text-black px-12 py-5 squircle font-black text-xs uppercase tracking-widest hover:scale-[0.98] transition-all"
            >
              Initiate Sequence
            </button>
          </div>
        </div>
      </section>

      <section
        class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-24 animate-up"
        style="animation-delay: 0.2s"
      >
        <div class="glass squircle p-8 border-white/5">
          <span
            class="text-[9px] font-bold text-white/20 uppercase tracking-widest block mb-2"
            >Neural Load</span
          >
          <div class="flex items-baseline gap-2">
            <span
              class="text-5xl font-black italic tracking-tighter"
              id="totalCourses"
              >0</span
            >
            <span class="text-xs font-bold text-white/40 uppercase"
              >Vectors</span
            >
          </div>
        </div>
        <div class="glass squircle p-8 border-indigo-500/10">
          <span
            class="text-[9px] font-bold text-white/20 uppercase tracking-widest block mb-2"
            >Current Efficiency</span
          >
          <div class="flex items-baseline gap-2">
            <span
              class="text-5xl font-black italic tracking-tighter text-indigo-400"
              id="avgMastery"
              >0%</span
            >
            <span class="text-xs font-bold text-white/40 uppercase"
              >Mastery</span
            >
          </div>
        </div>
      </section>

      <section class="animate-up" style="animation-delay: 0.3s">
        <div class="flex items-center gap-6 mb-12">
          <h2
            class="text-[10px] font-black text-white/40 uppercase tracking-[0.5em]"
          >
            Active Archives
          </h2>
          <div class="h-[1px] flex-1 bg-white/10"></div>
        </div>
        <div
          id="vectorGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        ></div>
      </section>
    </main>

    <script type="module">
      import auth from "./js/auth.js";

      /* ===============================
     STATE & DOM
  =============================== */
      const STATE = {
        courses: [],
        stats: null,
      };

      const DOM = {
        startBtn: document.getElementById("startBtn"),
        topicInput: document.getElementById("topicInput"),
        vectorGrid: document.getElementById("vectorGrid"),
        loader: document.getElementById("loaderOverlay"),
      };

      /* ===============================
     INIT
  =============================== */
      async function init() {
        if (!localStorage.getItem("accessToken")) {
          window.location.href = "signin.html";
          return;
        }

        const { name } = JSON.parse(localStorage.getItem("user")) || {
          name: "OPERATOR",
        };

        document.getElementById(
          "welcomeMsg"
        ).innerText = `ID: ${name.toUpperCase()}`;

        // 1ï¸âƒ£ Load cached courses instantly
        loadCoursesFromCache();
        updateUI();

        // 2ï¸âƒ£ Delta sync with server (non-blocking)
        syncCoursesFromServer();

        // 3ï¸âƒ£ Stats (independent)
        fetchStats().then(updateUI);
      }

      /* ===============================
     CACHE HELPERS
  =============================== */
      function loadCoursesFromCache() {
        try {
          STATE.courses = JSON.parse(
            localStorage.getItem("allCourses") || "[]"
          );
        } catch {
          STATE.courses = [];
        }
      }

      function getCachedCourseIds() {
        try {
          return (STATE.courses || []).map((c) => c?.data?._id).filter(Boolean);
        } catch {
          return [];
        }
      }

      /* ===============================
     DELTA SYNC (CORE LOGIC)
  =============================== */
      async function syncCoursesFromServer() {
        try {
          const existingCourseIds = getCachedCourseIds();

          const res = await fetch(
            "http://localhost:5500/content/getAllCourses",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...auth.getHeaders(), // JWT only
              },
              body: JSON.stringify({
                existingCourseIds, // ðŸ”¥ ONLY IDS
              }),
            }
          );

          if (!res.ok) throw new Error("Delta sync failed");

          const newCourses = await res.json();
          if (!Array.isArray(newCourses) || newCourses.length === 0) return;

          const formatted = newCourses.map((course) => ({
            topicName: course.title,
            timestamp: new Date(course.createdAt).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            }),
            data: course,
          }));

          const merged = [...formatted, ...STATE.courses];

          STATE.courses = merged;
          localStorage.setItem("allCourses", JSON.stringify(merged));

          updateUI();
        } catch (err) {
          console.warn("Using cached courses (delta sync failed)");
        }
      }

      /* ===============================
     STATS
  =============================== */
      async function fetchStats() {
        try {
          const res = await fetch(
            "http://localhost:5500/learning-time/heatmap",
            { headers: auth.getHeaders() }
          );
          if (res.ok) STATE.stats = await res.json();
        } catch {
          // silent fallback
        }
      }
      /* ===============================
      getProgress
   =============================== */
      async function fetchCourseProgress(courseId) {
        try {
          const res = await fetch(
            `http://localhost:5500/progress/${courseId}`,
            { headers: auth.getHeaders() }
          );

          if (!res.ok) return null;

          const data = await res.json();
          return data;
        } catch (err) {
          return null;
        }
      }

      /* ===============================
     PROGRESS CALC
  =============================== */
      async function calculateProgress(course) {
        const courseProgress = await fetchCourseProgress(course.data._id);
        const chaptersCount = course.data?.chapters?.length || 0;

        const numberOfChaptersCompleted = Object.values(
          courseProgress?.topicProgress || {}
        ).reduce((sum, t) => sum + (t.completed ? 1 : 0), 0);

        const progress = Math.min(
          Math.round((numberOfChaptersCompleted / chaptersCount) * 100),
          100
        );
      if (progress === 100 && !courseProgress.completed) {
        await auth.authFetch("http://localhost:5500/course/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ courseId: course.data._id }),
        });
      }
        return progress;
        }
      // }
      async function calculateProgress_Quiz(course) {
        const courseProgress = await fetchCourseProgress(course.data._id);
        if (!courseProgress) return 0;

        const allTopics =
          course.data?.chapters?.flatMap((ch) => ch.topics) || [];

        if (!allTopics.length) return 0;

        const passedTopics = Object.values(
          courseProgress.topicProgress || {}
        ).filter((t) => t.quizPassed === true).length;

        const progress = Math.round((passedTopics / allTopics.length) * 100);

        return Math.min(progress, 100);
      }

      /* ===============================
     UI RENDER
  =============================== */
      async function updateUI() {
        document.getElementById("totalCourses").innerText =
          STATE.courses.length;

        /* ===== Time + streak ===== */
        let seconds = 0;
        if (STATE.stats) {
          seconds = STATE.stats.totalLearningTime || 0;
          document.getElementById("streakVal").innerText = `${
            STATE.stats.streak || 0
          } DAY STREAK`;
        } else {
          seconds = parseInt(localStorage.getItem("learningTime") || "0");
        }

        const h = String(Math.floor(seconds / 3600)).padStart(2, "0");
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
        const s = String(seconds % 60).padStart(2, "0");
        document.getElementById("timeVal").innerText = `${h}:${m}:${s}`;

        if (!STATE.courses.length) {
          DOM.vectorGrid.innerHTML = `
      <div class="col-span-full py-20 text-center border border-dashed border-white/5 squircle">
        <p class="text-white/20 text-xs font-bold uppercase tracking-widest">
          No neural archives found.
        </p>
      </div>`;
          return;
        }

        /* ===== FIX: resolve async progress first ===== */
        const progressList = await Promise.all(
          STATE.courses.map((course) => calculateProgress(course))
        );

        let totalMastery = 0;

        DOM.vectorGrid.innerHTML = STATE.courses
          .map((course, idx) => {
            const progress = progressList[idx];
            totalMastery += progress;

            return `
        <div onclick="launchCourse(${idx})"
          class="vector-card glass squircle p-10 cursor-pointer transition-all border border-white/5 hover:border-indigo-500/40"
          style="--progress:${progress}%">

          <div class="flex justify-between mb-16">
            <span class="text-[8px] font-black text-indigo-400 uppercase tracking-widest">
              Vector Synced
            </span>
            <span class="text-[9px] text-white/20 uppercase">
              ${course.timestamp}
            </span>
          </div>

          <h3 class="text-2xl font-black uppercase italic">
            ${course.topicName}
          </h3>

          <div class="flex justify-between mt-8">
            <span class="text-xs text-white/30 uppercase">
              ${course.data?.chapters?.length || 0} Modules
            </span>
            <span class="text-xs text-indigo-400 font-black">
              ${progress}%
            </span>
          </div>
        </div>`;
          })
          .join("");

        document.getElementById("avgMastery").innerText = `${Math.round(
          totalMastery / STATE.courses.length
        )}%`;
      }
      /* ===============================
     ACTIONS
  =============================== */
      DOM.startBtn.onclick = async () => {
        const topic = DOM.topicInput.value.trim();
        if (!topic) return;

        DOM.loader.classList.remove("hidden");
        DOM.loader.classList.add("flex");

        try {
          const res = await fetch("http://localhost:5500/content", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...auth.getHeaders(),
            },
            body: JSON.stringify({ topicName: topic }),
          });

          if (!res.ok) throw new Error();

          const data = await res.json();

          const entry = {
            topicName: topic,
            timestamp: new Date().toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            }),
            data: data.course,
          };

          const updated = [entry, ...STATE.courses];
          localStorage.setItem("allCourses", JSON.stringify(updated));
          localStorage.setItem("courseData", JSON.stringify(entry.data));

          window.location.href = "course.html";
        } catch {
          alert("Protocol Error: Synthesis failed.");
          DOM.loader.classList.add("hidden");
        }
      };

      window.launchCourse = (idx) => {
        const course = STATE.courses[idx];
        course.data.topicName = course.topicName;
        localStorage.setItem("courseData", JSON.stringify(course.data));
        window.location.href = "course.html";
      };

      document.getElementById("logoutBtn").onclick = auth.logout;

      init();
    </script>
  </body>
</html>
